<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cleanup Old Product Documents</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
    .success {
      background: #d4edda;
      border: 1px solid #28a745;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #dc3545;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
    button {
      background: #dc3545;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px 10px 0;
    }
    button:hover {
      background: #c82333;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
    .products-list {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }
    .products-list ul {
      margin: 10px 0;
      padding-left: 25px;
    }
    .loading {
      color: #6c757d;
      font-style: italic;
    }
    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üßπ Cleanup Old Product Documents</h1>
    <p>This tool will help you delete old "product" type documents that are causing issues after the schema rename.</p>
    
    <div class="warning">
      <strong>‚ö†Ô∏è Warning:</strong> This action cannot be undone. Make sure you want to delete these documents before proceeding.
    </div>

    <div id="status"></div>
    <div id="products-list"></div>

    <button onclick="checkProducts()">Check for Old Products</button>
    <button onclick="deleteProducts()" class="secondary" id="deleteBtn" disabled>Delete All Old Products</button>

    <hr style="margin: 30px 0;">
    
    <h2>What is this?</h2>
    <p>After renaming the Sanity schema from "product" to "project", old "product" documents may still exist in your database. These orphaned documents can cause errors in Sanity Studio.</p>
    
    <h2>How to use:</h2>
    <ol>
      <li>Click <strong>"Check for Old Products"</strong> to see what documents would be deleted</li>
      <li>Review the list</li>
      <li>If you're sure, click <strong>"Delete All Old Products"</strong></li>
      <li>After cleanup, refresh your Sanity Studio and create new "project" documents</li>
    </ol>
  </div>

  <script>
    let products = [];

    async function checkProducts() {
      const statusDiv = document.getElementById('status');
      const productsDiv = document.getElementById('products-list');
      const deleteBtn = document.getElementById('deleteBtn');

      statusDiv.innerHTML = '<p class="loading">Checking for old products...</p>';
      productsDiv.innerHTML = '';
      deleteBtn.disabled = true;

      try {
        const response = await fetch('/api/cleanup-old-products');
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to check products');
        }

        products = data.products || [];

        if (products.length === 0) {
          statusDiv.innerHTML = '<div class="success"><strong>‚úì Success!</strong> No old "product" documents found. Your database is clean!</div>';
        } else {
          const references = data.references || [];
          let refsHtml = '';
          if (references.length > 0) {
            refsHtml = `
              <div class="warning" style="margin-top: 15px;">
                <h3>‚ö†Ô∏è Client References Found:</h3>
                <p>The following client documents reference these old products. These references will be automatically removed:</p>
                <ul>
                  ${references.map(r => `<li><strong>${r.clientTitle}</strong> (${r.referencedProductCount} reference(s))</li>`).join('')}
                </ul>
              </div>
            `;
          }
          
          statusDiv.innerHTML = `<div class="warning"><strong>Found ${products.length} old "product" document(s)</strong></div>`;
          productsDiv.innerHTML = `
            <div class="products-list">
              <h3>Documents to be deleted:</h3>
              <ul>
                ${products.map(p => `<li><strong>${p.title || 'Untitled'}</strong> (ID: <code>${p._id}</code>)</li>`).join('')}
              </ul>
            </div>
            ${refsHtml}
          `;
          deleteBtn.disabled = false;
        }
      } catch (error) {
        statusDiv.innerHTML = `<div class="error"><strong>Error:</strong> ${error.message || 'Unknown error occurred'}</div>`;
        console.error('Error deleting products:', error);
      }
    }

    async function deleteProducts() {
      const statusDiv = document.getElementById('status');
      const productsDiv = document.getElementById('products-list');
      const deleteBtn = document.getElementById('deleteBtn');

      if (products.length === 0) {
        alert('Please check for products first!');
        return;
      }

      if (!confirm(`Are you sure you want to delete ${products.length} document(s)? This cannot be undone!`)) {
        return;
      }

      statusDiv.innerHTML = '<p class="loading">Deleting old products...</p>';
      deleteBtn.disabled = true;

      try {
        const response = await fetch('/api/cleanup-old-products', {
          method: 'DELETE',
        });
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to delete products');
        }

        let messageHtml = `<div class="success"><strong>‚úì Success!</strong> ${data.message}</div>`;
        
        if (data.referenceRemovalResults && data.referenceRemovalResults.length > 0) {
          const refSuccess = data.referenceRemovalResults.filter(r => r.success);
          if (refSuccess.length > 0) {
            messageHtml += `<div class="success" style="margin-top: 10px;">
              <strong>References Removed:</strong>
              <ul style="margin: 10px 0;">
                ${refSuccess.map(r => `<li>${r.clientTitle}: Removed ${r.removedCount} reference(s)</li>`).join('')}
              </ul>
            </div>`;
          }
        }
        
        statusDiv.innerHTML = messageHtml;
        productsDiv.innerHTML = '';
        products = [];
        
        if (data.results) {
          const failed = data.results.filter(r => !r.success);
          if (failed.length > 0) {
            let errorDetails = '<ul style="margin: 10px 0;">';
            failed.forEach(f => {
              errorDetails += `<li><strong>${f.title}</strong>: ${f.error || 'Unknown error'}</li>`;
            });
            errorDetails += '</ul>';
            statusDiv.innerHTML += `<div class="error"><strong>Note:</strong> ${failed.length} document(s) could not be deleted:${errorDetails}<p>They may need to be deleted manually in Sanity Studio, or there may be other references preventing deletion.</p></div>`;
          }
        }
      } catch (error) {
        statusDiv.innerHTML = `<div class="error"><strong>Error:</strong> ${error.message || 'Unknown error occurred'}</div>`;
        console.error('Error deleting products:', error);
      }
    }

    // Auto-check on page load
    window.addEventListener('load', () => {
      checkProducts();
    });
  </script>
</body>
</html>

